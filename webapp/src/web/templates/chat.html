<html>
   <head>
      <title>{{ title }}</title>
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
      <style>
         .clearfix {
         overflow: auto;
         }
         .points {
         color: #009933;
         }
         div#chat_container {
         float:left;
         width: 40%;
         }
         div#info_container {
         margin-left: 42%;
         color:#004d00;
         }
         div#icon {
         padding: 10px 100px 10px 20px;
         display: inline-block;
         }
         textarea#chat {
         width: 100%;
         cols: 100;
         height: 25%;
         color:#004d00;
         font-size:14px;
         }
         input#text {
         width: 100%;
         }
         td {
         padding: 0 15px 0 15px;
         }
         #instructions > p,li {
         font-size:15px;
         }
         table.sortable th:not(.sorttable_sorted):not(.sorttable_sorted_reverse):not(.sorttable_nosort):after {
         content: " \25B4\25BE"
         }
         table.sortable {
         color:#004d00;
         }
         table { 
         border-collapse: collapse; 
         }
         tr:nth-child(n) { 
         border: solid thin;
         }
         #clockdiv{
         display: inline-block;
         font-weight: bold;
         text-align: center;
         font-size: 18px;
         padding: 15px 0 15px 0;
         }
         #clockdiv > div{
         display: inline-block;
         }
         #clockdiv div > span{
         display: inline-block;
         }
         #clockdiv div > .seconds{
         margin-left:-3px;
         }
         button.disabled{
         display: none;
         }
      </style>
    	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
        <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
      <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
      <script type="text/javascript" charset="utf-8">
         var validCheckInterval, inboxCheckInterval;
//         var BASE_URL = 'http://' + document.domain + ':' + location.port;
         var selectTime = null, messageStartTime = null;
         var messageTime = 0.0;
         var initTime = new Date()
         {% if not debug %}
            var read_time = 1000; // milliseconds
            //var select_time = read_time; // milliseconds
            var select_time = 60000; // milliseconds, 1 min
         {% else %}
            var read_time = 1000;  // In peek/debug mode, skip it
            var select_time = 60000; // 1 min
         {% endif %}
         $(document).ready(function(){
         	$('#description').modal({backdrop: 'static', keyboard: true});
           /*
         	$('#description').dialog({
          modal: true,
          autoOpen: false,
            buttons: {
              Ok: function() {
                $(this).dialog("close");
              }
            }
          });
          */
            $('#description').modal('show');
            //$('#description').dialog('show');
            //$("#instructionCollapse").click();
            window.onbeforeunload = disconnect;

            //document.getElementById('modal_instruction').innerHTML = "(This window will automatically collapse and the chat will start after " + read_time/1000 +" seconds).";

            var deadline = new Date(Date.parse(new Date()) + ({{ num_seconds }}) * 1000);

         	$.ajax({
                  		url: '{{ url_for('chat.connect')}}',
                  		type: "get",
                  		data: {"uid": "{{ uid }}" },
                  		dataType: "json"
            });
         
             $.ajax({
                  		url: '{{ url_for('chat.join_chat')}}',
                  		type: "get",
                  		data: {"uid": "{{ uid }}"},
                  		dataType: "json",
                  		success: function(response) {
                  			displayText(response['message']);
                  		}
            });
         
         	validCheckInterval = setInterval(pollServer, 3000);

         	setTimeout(function(){


                  inboxCheckInterval = setInterval(checkInbox, 1000);

         			$('#text').keypress(function(e) {
         				var code = e.keyCode || e.which;
         				if ($('#text').val().length == 0) {
         				messageStartTime = Date.now() / 1000.0;
         				}
         			   if (code == 13) {
         				   text = $('#text').val();
         				   $('#text').val('');
         				   var currentTime = Date.now() / 1000.0;
         				   messageTime = currentTime - messageStartTime;
         				   sendMessage(text);
                           disableChat();
         				   messageStartTime = null;
         				   messageTime = 0.0;
         			   }
         		   });
         	}, read_time); 

         });

    	 var canSelectDot = true;

         function makeSelection(selected) {
           if (!canSelectDot) {
             window.alert("It's your partner's turn; you can select a dot after they write a message or select a dot.")
             return;
           }
         	if(selectTime == null) {
               // if no selection has been made before, log selection and save selection time
               now = new Date();
               console.log(now - initTime)
               if(now - initTime > read_time + select_time) {
                  selectTime = now;
                  select(selected);
               } else {
                  window.alert("Please play for least one minute before selecting a dot.")
               }
         	} else {
         	  window.alert("You've already selected a dot in this game.");
         	  /*
         		var currentTime = new Date();
         		// check if last selection was more than 10 seconds ago; selections can only be made > 10 seconds apart.
         		// If the last selection was made < 10 seconds ago, do nothing (no selection event is logged).
         		if ((currentTime - selectTime) > 10000) {
         			select(selected);
         			selectTime = currentTime;
         		} // otherwise do nothing
         		*/
         	}
         }
         /*
         function startedTyping() {
            $.ajax({
                          url: '{{ url_for('chat.typing_event')}}',
                          type: "get",
                          data: {
                              "uid": "{{ uid }}",
                              "action": "started"
                          }
                      });
                  }
         
                  function stoppedTyping() {
                      $.ajax({
                          url: '{{ url_for('chat.typing_event')}}',
                          type: "get",
                          data: {
                              "uid": "{{ uid }}",
                              "action": "stopped"
                          }
                      });
                  }
         */
   
         function displayText(message) {
         	$('#chat').val($('#chat').val() + message + '\n');
         	$('#chat').scrollTop($('#chat')[0].scrollHeight);
         }
         
                  function displayStatus(message) {
                      $('#status').val(message);
                  }
         
         function sendMessage(message) {
         	$.ajax({
         		url: '{{ url_for('chat.send_message')}}',
         		type: "get",
         		data: {
         			"uid": "{{ uid }}",
         			"message": message,
         			"time_taken": messageTime
         		},
         		dataType: "json",
         		success: function(response) {
         			displayText(response['message']);
         		}
         	});
         }
         function select(selection) {
         	$.ajax({
         		url: '{{ url_for('action.select_option')}}',
         		type: "get",
         		data: { 
         			"uid": "{{ uid }}",
         			"selection": selection
         		},
         		dataType: "json",
         		success: function(response) {
         			displayText(response['message']);
         		}
         
         	});
         }
         function checkInbox() {
         	$.ajax({
         		url: '{{ url_for('chat.check_inbox')}}',
         		type: "get",
         		data: { "uid": "{{ uid }}" },
         		dataType: "json",
         		success: function(response) {
         		  console.log(response);
         			if(response['received']	) {
                if(response['status']) {
                  displayStatus(response['message']);
                } else if ('message' in response) {
                  displayText(response['message']);
                  console.debug(response['message']);
                  enableChat();
                }
                if (('disable_chat' in response) && (response['disable_chat'])) {
                  disableChat();
                }
            chatBeep();
              }
         		}
         	});
         }
         
         function pollServer() {
            // delete this later
         	$.ajax({
         		url: '{{ url_for('chat.check_chat_valid')}}',
         		type: "get",
         		data: {"uid": "{{ uid }}"},
         		dataType: "json",
         		success: function(response) {
         			if(!response['valid']) {
         				disconnect();
         				window.location.reload(true);
         			}
         		}
         	});
         	
         }
         
         function disconnect() {
                  	clearInterval(validCheckInterval);
                  	clearInterval(inboxCheckInterval);
                  	$.ajax({
                  		url: '{{ url_for('chat.leave_chat')}}',
                  		type: "get",
                  		data: {"uid": "{{ uid }}"}
                  	});
                  	$.ajax({
                  		url: '{{ url_for('chat.disconnect')}}',
                  		type: "get",
                  		data: {"uid": "{{ uid }}" }
                  	});
                  }
                  
                  
//                  function skipChat() {
//                   disconnect();
//                  	$.ajax({
//                  		url: BASE_URL + '/_skip_chat/',
//                  		type: "get",
//                  		data: {"uid": "{{ uid }}"}
//         	         });			
//         	         window.location.reload(true);
//                   }
         
      </script>
      <script type="text/javascript" charset="utf-8">
         function getTimeRemaining(endtime) {
         	var t = Date.parse(endtime) - Date.parse(new Date());
         	var seconds = Math.floor((t / 1000) % 60);
         	var minutes = Math.floor((t / 1000 / 60));
         	return {
         		'total': t,
         		'minutes': minutes,
         		'seconds': seconds
         	};
         }
         
         function initializeClock(id, endtime) {
         	var clock = document.getElementById(id);
         	var minutesSpan = clock.querySelector('.minutes');
         	var secondsSpan = clock.querySelector('.seconds');
         
         	function updateClock() {
         		var t = getTimeRemaining(endtime);
         		minutesSpan.innerHTML = t.minutes+':';
         		secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);
         		//console.log(t.total/1000);
         		if (t.total / 1000 <= {{ quit_after|int }} && {{ quit_enabled }}) {
         			$("#leave").css("display", "inline-block");
         		}
         		if (t.total <= 0) {
         			clearInterval(validCheckInterval);
         			clearInterval(timeinterval);
         			pollServer();
         		}
         	}
         
         	updateClock();
         	var timeinterval = setInterval(updateClock, 1000);
         }
         
         function init() {
         	var deadline = new Date(Date.parse(new Date()) + {{ num_seconds }} * 1000);
         	initializeClock('clockdiv', deadline);
         }

        function chatBeep() {
          const audio = new Audio("{{ url_for('static', filename='')}}chat.wav");
          audio.play();
        }

         function disableChat() {
            $("#text").attr("disabled", "disabled")
            $("#text").attr("placeholder", "Waiting on your partner to take a turn...")
           canSelectDot = false;
         }
 
         function enableChat() {
            $("#text").removeAttr('disabled');
            $("#text").attr("placeholder", "Enter your message here")
           canSelectDot = true;
         }
 
         function hideModal() {
           $('#description').modal('hide')
         }
 
         function showModal() {
           $('#description').modal('show')
         }
      </script>
   </head>
   <body onload='init()' oncopy="return false" oncut="return false" onpaste="return false">
      <div class="clearfix">
         <!-- Modal -->
         <div class="modal fade" id="description" role="dialog">
            <div class="modal-dialog modal-lg">
               <!-- Modal content-->
               <div class="modal-content">
                 <div align="right"> <button onclick="hideModal()" >X</button> </div>
                  <div class="modal-header">
                     <h3>Task Overview:</h3>
                        <p id="modal_instruction"></p>
                        <p>You'll be paired with a partner. You and your partner can both see 7 objects in your view. However, your view is centered slightly differently from your partner's, and only some objects are in common. Your goal is <span style="color:#009933"> to chat with your partner and find one object you have in common!</span></p>
                  </div>
                  <div class="modal-body">
                    <table>
                      <tr>
                        <td>
                     <h4>Example Scenario:</h4>
                     <img height="400" width="400" src="{{ url_for('static', filename='img/')}}sample_colored.png"/>
                        </td>
                        <td>
                     <h4>Example Conversation:</h4>
                     <ul style="list-style-type:none">
                        <li> <span style="color:#0000FF">Player1:</span> I see a lonely light gray dot. </li>
                        <li> <span style="color:#FF0000">Player2:</span> I don't think I see it. </li>
                        <li> <span style="color:#0000FF">Player1:</span> Ok, then do you see two dark dots. </li>
                        <li> <span style="color:#FF0000">Player2:</span> Is the lower one slightly larger? </li>
                        <li> <span style="color:#0000FF">Player1:</span> Yes, they are almost vertical. </li>
                        <li> <span style="color:#FF0000">Player2:</span> Let's choose the lower one! </li>
                     </ul>
                        </td>
                    </table>
                    You'll see more detailed instructions after clicking Close below!
                  </div>
                 <div align="center"> <button onclick="hideModal()" >Close</button> </div>
               </div>
            </div>
         </div>

         <div id="chat_container">
            <div id="instructions">
               <h1 style="color:#004d00">{{ title}}</h1>
               <!-- <button type="button" id="instructionCollapse" class="btn btn-info disabled" data-toggle="collapse"  data-target="#inner">Show/Hide Instructions</button> -->
            	<div id="inner">
	               {{ instructions }}
	            </div>
            </div>
            <div id="clockdiv" align="right">
               Time Remaining: 
               <div>
                  <span class="minutes"></span>
                  <span class="seconds"></span>
               </div>
            </div>
            <textarea readonly id="chat"></textarea>
            <br><br>
            <!-- <input readonly id="status" style="width:100%;"><br><br> -->
            <input id="text" placeholder="Enter your text here"><br><br> 
            <!-- <input id="text" placeholder="Waiting on your partner to take a turn..."><br><br> -->
         </div>
         <div id="info_container">
            <div id="topright">
               <div id="icon">
                  <img height="120" width="120" src="{{ url_for('static', filename='img/')}}{{icon}}"/>
               </div>
               <!--<h4><a href="javascript:skipChat();">Click here</a> to end this chat.</h4>-->
            </div>
         </div>
         <div id="friends">
            <h3> Your view</h3>
            <svg id="svg" width="430" height="430">
               <circle cx="215" cy="215" r="205" fill="none" stroke="black" stroke-width="2" stroke-dasharray="3,3"/>
               {% for item in kb %}
               <circle cx="{{item['x']}}" cy="{{item['y']}}" r="{{item['size']}}" fill="{{item['color']}}"
                  onclick="makeSelection({{item['id']}})" />
               {% endfor %}
               </a>
            </svg>
         </div>
         {% if partner_kb %}
        <div id="peek">
            <h3> Bot's view</h3>
            <svg id="svg" width="430" height="430">
               <circle cx="215" cy="215" r="205" fill="none" stroke="black" stroke-width="2" stroke-dasharray="3,3"/>
               {% for item in partner_kb %}
               <circle cx="{{item['x']}}" cy="{{item['y']}}" r="{{item['size']}}" fill="{{item['color']}}"/>
               {% endfor %}
               </a>
            </svg>
        </div>
        {% endif %}
      </div>
      </div>
   </body>
</html>


<script id="hitpub_js">
// TimeMe.js
(function () { var e, t; e = this, t = function () { var r = { startStopTimes: {}, idleTimeoutMs: 3e4, currentIdleTimeMs: 0, checkStateRateMs: 250, active: !1, idle: !1, currentPageName: "default-page-name", timeElapsedCallbacks: [], userLeftCallbacks: [], userReturnCallbacks: [], trackTimeOnElement: function (e) { var t = document.getElementById(e); t && (t.addEventListener("mouseover", function () { r.startTimer(e) }), t.addEventListener("mousemove", function () { r.startTimer(e) }), t.addEventListener("mouseleave", function () { r.stopTimer(e) }), t.addEventListener("keypress", function () { r.startTimer(e) }), t.addEventListener("focus", function () { r.startTimer(e) })) }, getTimeOnElementInSeconds: function (e) { var t = r.getTimeOnPageInSeconds(e); return t || 0 }, startTimer: function (e, t) { if (e || (e = r.currentPageName), void 0 === r.startStopTimes[e]) r.startStopTimes[e] = []; else { var n = r.startStopTimes[e], i = n[n.length - 1]; if (void 0 !== i && void 0 === i.stopTime) return } r.startStopTimes[e].push({ startTime: t || new Date, stopTime: void 0 }), r.active = !0, r.idle = !1 }, stopAllTimers: function () { for (var e = Object.keys(r.startStopTimes), t = 0; t < e.length; t++)r.stopTimer(e[t]) }, stopTimer: function (e, t) { e || (e = r.currentPageName); var n = r.startStopTimes[e]; void 0 !== n && 0 !== n.length && (void 0 === n[n.length - 1].stopTime && (n[n.length - 1].stopTime = t || new Date), r.active = !1) }, getTimeOnCurrentPageInSeconds: function () { return r.getTimeOnPageInSeconds(r.currentPageName) }, getTimeOnPageInSeconds: function (e) { var t = r.getTimeOnPageInMilliseconds(e); return void 0 === t ? void 0 : t / 1e3 }, getTimeOnCurrentPageInMilliseconds: function () { return r.getTimeOnPageInMilliseconds(r.currentPageName) }, getTimeOnPageInMilliseconds: function (e) { var t = r.startStopTimes[e]; if (void 0 !== t) { for (var n = 0, i = 0; i < t.length; i++) { var s = t[i].startTime, o = t[i].stopTime; void 0 === o && (o = new Date), n += o - s } return Number(n) } }, getTimeOnAllPagesInSeconds: function () { for (var e = [], t = Object.keys(r.startStopTimes), n = 0; n < t.length; n++) { var i = t[n], s = r.getTimeOnPageInSeconds(i); e.push({ pageName: i, timeOnPage: s }) } return e }, setIdleDurationInSeconds: function (e) { var t = parseFloat(e); if (!1 !== isNaN(t)) throw { name: "InvalidDurationException", message: "An invalid duration time (" + e + ") was provided." }; return r.idleTimeoutMs = 1e3 * e, this }, setCurrentPageName: function (e) { return r.currentPageName = e, this }, resetRecordedPageTime: function (e) { delete r.startStopTimes[e] }, resetAllRecordedPageTimes: function () { for (var e = Object.keys(r.startStopTimes), t = 0; t < e.length; t++)r.resetRecordedPageTime(e[t]) }, resetIdleCountdown: function () { r.idle && r.triggerUserHasReturned(), r.idle = !1, r.currentIdleTimeMs = 0 }, callWhenUserLeaves: function (e, t) { this.userLeftCallbacks.push({ callback: e, numberOfTimesToInvoke: t }) }, callWhenUserReturns: function (e, t) { this.userReturnCallbacks.push({ callback: e, numberOfTimesToInvoke: t }) }, triggerUserHasReturned: function () { if (!r.active) for (var e = 0; e < this.userReturnCallbacks.length; e++) { var t = this.userReturnCallbacks[e], n = t.numberOfTimesToInvoke; (isNaN(n) || void 0 === n || 0 < n) && (t.numberOfTimesToInvoke -= 1, t.callback()) } r.startTimer() }, triggerUserHasLeftPage: function () { if (r.active) for (var e = 0; e < this.userLeftCallbacks.length; e++) { var t = this.userLeftCallbacks[e], n = t.numberOfTimesToInvoke; (isNaN(n) || void 0 === n || 0 < n) && (t.numberOfTimesToInvoke -= 1, t.callback()) } r.stopAllTimers() }, callAfterTimeElapsedInSeconds: function (e, t) { r.timeElapsedCallbacks.push({ timeInSeconds: e, callback: t, pending: !0 }) }, checkState: function () { for (var e = 0; e < r.timeElapsedCallbacks.length; e++)r.timeElapsedCallbacks[e].pending && r.getTimeOnCurrentPageInSeconds() > r.timeElapsedCallbacks[e].timeInSeconds && (r.timeElapsedCallbacks[e].callback(), r.timeElapsedCallbacks[e].pending = !1); !1 === r.idle && r.currentIdleTimeMs > r.idleTimeoutMs ? (r.idle = !0, r.triggerUserHasLeftPage()) : r.currentIdleTimeMs += r.checkStateRateMs }, visibilityChangeEventName: void 0, hiddenPropName: void 0, listenForVisibilityEvents: function () { void 0 !== document.hidden ? (r.hiddenPropName = "hidden", r.visibilityChangeEventName = "visibilitychange") : void 0 !== document.mozHidden ? (r.hiddenPropName = "mozHidden", r.visibilityChangeEventName = "mozvisibilitychange") : void 0 !== document.msHidden ? (r.hiddenPropName = "msHidden", r.visibilityChangeEventName = "msvisibilitychange") : void 0 !== document.webkitHidden && (r.hiddenPropName = "webkitHidden", r.visibilityChangeEventName = "webkitvisibilitychange"), document.addEventListener(r.visibilityChangeEventName, function () { document[r.hiddenPropName] ? r.triggerUserHasLeftPage() : r.triggerUserHasReturned() }, !1), window.addEventListener("blur", function () { r.triggerUserHasLeftPage() }), window.addEventListener("focus", function () { r.triggerUserHasReturned() }), document.addEventListener("mousemove", function () { r.resetIdleCountdown() }), document.addEventListener("keyup", function () { r.resetIdleCountdown() }), document.addEventListener("touchstart", function () { r.resetIdleCountdown() }), window.addEventListener("scroll", function () { r.resetIdleCountdown() }), setInterval(function () { r.checkState() }, r.checkStateRateMs) }, websocket: void 0, websocketHost: void 0, setUpWebsocket: function (e) { if (window.WebSocket && e) { var t = e.websocketHost; try { r.websocket = new WebSocket(t), window.onbeforeunload = function () { r.sendCurrentTime(e.appId) }, r.websocket.onopen = function () { r.sendInitWsRequest(e.appId) }, r.websocket.onerror = function (e) { console && console.log("Error occurred in websocket connection: " + e) }, r.websocket.onmessage = function (e) { console && console.log(e.data) } } catch (e) { console && console.error("Failed to connect to websocket host.  Error:" + e) } } return this }, websocketSend: function (e) { r.websocket.send(JSON.stringify(e)) }, sendCurrentTime: function (e) { var t = { type: "INSERT_TIME", appId: e, timeOnPageMs: r.getTimeOnCurrentPageInMilliseconds(), pageName: r.currentPageName }; r.websocketSend(t) }, sendInitWsRequest: function (e) { var t = { type: "INIT", appId: e }; r.websocketSend(t) }, initialize: function (e) { var t = r.idleTimeoutMs || 30, n = r.currentPageName || "default-page-name", i = void 0, s = void 0; e && (t = e.idleTimeoutInSeconds || t, n = e.currentPageName || n, i = e.websocketOptions, s = e.initialStartTime), r.setIdleDurationInSeconds(t).setCurrentPageName(n).setUpWebsocket(i).listenForVisibilityEvents(), r.startTimer(void 0, s) } }; return r }, "undefined" != typeof module && module.exports ? module.exports = t() : "function" == typeof define && define.amd ? define([], function () { return e.TimeMe = t() }) : e.TimeMe = t() }).call(this);

TimeMe.initialize({
    currentPageName: "task",
    idleTimeoutInSeconds: 30
});

$(document).ready(function() {
    $('#submitButton').click(function () {
        try {
            $('input[name=tm]').attr('value', TimeMe.getTimeOnCurrentPageInSeconds());
        } catch {
        }
        return true;
    });
});
</script>
